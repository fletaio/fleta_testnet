<%define "vue_func"%>
<script src="/assets/js/vue.js"></script>
<script src="/assets/js/vue-resource.min.js"></script>
<script src="/assets/js/bigint.min.js"></script>

<script>
window.listener_map = {};
window.caller_map = {};
window.cast = function(name) {
	var fns = window.listener_map[name];
	var callers = window.caller_map[name];
	if (fns) {
		var args = [];
		for (var i = 1; i < arguments.length; i++) {
			args.push(arguments[i]);
		}
		for (var i = 0; i < fns.length; i++) {
			fns[i].apply(callers[i], args);
		}
	}
};
window.listen = function(name, caller, fn) {
	var fns = window.listener_map[name];
	var callers = window.caller_map[name];
	if (!fns) {
		fns = [];
		callers = [];
		window.listener_map[name] = fns;
		window.caller_map[name] = callers;
	}
	fns.push(fn);
	callers.push(caller);
};

window.pad = function(str, len) {
	str = str.toString();
	var list = [];
	for(var i=str.length; i<len; i++) {
		list.push("0");
	}
	list.push(str);
	return list.join("");
};

window.rpad = function(str, len) {
	str = str.toString();
	var list = [];
	list.push(str);
	for(var i=str.length; i<len; i++) {
		list.push("0");
	}
	return list.join("");
};

jQuery.fn.datepicker.dates['kr'] = {
	days: ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일", "일요일"],
	daysShort: ["일", "월", "화", "수", "목", "금", "토", "일"],
	daysMin: ["일", "월", "화", "수", "목", "금", "토", "일"],
	months: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
	monthsShort: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
	titleFormat: "yyyy년 MM",
	format: "yyyy-mm-dd",
};

Vue.mixin({
	methods: {
		insert_comma: function(balance, decimal_places) {
			if(!balance || balance.toString().length == 0) {
				if(balance === 0) {
					return "0";
				}
				return "";
			}
			var ls = balance.toString().split(".");
			var list = [];
			for(var i=0; i<ls[0].length; i++) {
				list.push(ls[0][i]);
				if((ls[0].length - i - 1)%3 == 0 && i != ls[0].length-1) {
					list.push(",");
				}
			}
			if(ls.length == 1) {
				return list.join("");
			} else {
				if (!decimal_places || isNaN(decimal_places)) {
					return list.join("") + "." + ls[1];
				} else {
					var dp = parseInt(decimal_places)
					if (ls[1].length < dp) {
						return list.join("") + "." + ls[1]
					} else {
						return list.join("") + "." + ls[1].substr(0, dp)
					}
				}
			}
		},
		format_balance: function(balance, under) {
			if(!balance || balance.toString().length == 0) {
				if(balance === 0) {
					return "0";
				}
				return "";
			}
			if(under) {
				var ls = balance.toString().split(".");
				if(ls.length == 1) {
					return ls[0];
				} else {
					return ls[0] + "." + ls[1].substr(0, under);
				}
			} else {
				return balance.toString().split(".")[0];
			}
		},
		get_date: function(timestamp) {
			if(!timestamp) {
				return "";
			}
			var dt = new Date(timestamp/1000000);
			return dt.getFullYear() + "-" + pad(dt.getMonth()+1, 2) + "-" + pad(dt.getDate(), 2);
		},
		get_date_time: function(timestamp) {
			if(!timestamp) {
				return "";
			}
			var dt = new Date(timestamp/1000000);
			return dt.getFullYear() + "-" + pad(dt.getMonth()+1, 2) + "-" + pad(dt.getDate(), 2) + " " + pad(dt.getHours(), 2) + ":" + pad(dt.getMinutes(), 2) + ":" + pad(dt.getSeconds(), 2);
		},
		get_date_timezone: function(timestamp) {
			if(!timestamp) {
				return "";
			}
			var dt = new Date(timestamp/1000000);
			var ofs = -new Date().getTimezoneOffset()/60;
			var timezone = "";
			if(ofs > 0) {
				timezone = "+" + pad(ofs, 2) + ":00";
			} else {
				timezone = "-" + pad(-ofs, 2) + ":00";
			}
			return dt.getFullYear() + "-" + pad(dt.getMonth()+1, 2) + "-" + pad(dt.getDate(), 2) + " " + pad(dt.getHours(), 2) + ":" + pad(dt.getMinutes(), 2) + ":" + pad(dt.getSeconds(), 2) + " " + timezone; 
		},
		copy_to_clipboard: function(val, no_alert) {
			var t = document.createElement("textarea");
			t.value = val;
			document.body.appendChild(t);
			t.select();
			t.setSelectionRange(0, 9999);
			document.execCommand('copy');
			document.body.removeChild(t);

			if(!no_alert) {
				openLayerAlert('Copy_text')
			}
		},
		to_big: function(balance) {
			var unit = bigInt(1000000000000000000);
			var bs = balance.split(".");
			if(bs.length == 1) {
				return bigInt(bs[0]).multiply(unit);
			} else {
				var a = bigInt(bs[0]).multiply(unit);
				bs[1] = bs[1].substr(0, 18);
				var b = bigInt(rpad(bs[1], 18));
				return a.plus(b);
			}
		},
		to_coin: function(big) {
			var unit = bigInt(1000000000000000000);
			var a = big.divide(unit).toString();
			var b = big.mod(unit).toString();
			if(b == 0) {
				return a;
			} else {
				for(var i=b.length-1; i>=0; i--) {
					if(b[i] != "0") {
						b = b.substr(0, i+1);
						break;
					}
				}
				return a + "." + pad(b, 18);
			}
		},
	}
});

function HTMLtoString(html) {
	return html.trim().split("\n").join("").split("\t").join("").split('"').join('\\"')
}
function compileTarget(cont) {
	var name = cont.get(0).tagName.toLowerCase();
	var vues = cont.children().filter("script");
	if(vues.length > 1 ) {
		console.error("too many vue script");
		return;
	} else if (vues.length == 0) {
		console.error("no vue script");
		return;
	}
	var vue = vues.eq(0).detach().html();
	cont.find("script[type='vue']").each(function() {
		compileTarget($(this).parent());
	});
	var body = HTMLtoString(cont.html());
	var compiled = ('Vue.component("' + name + '", {' + vue + ', template: "' + body + '"})');
	var isEmbedded = (cont.parent().get(0) != document.body);
	var isSuccess = evalCompileTarget(compiled);

	var msg = "[vue-component](name : " + name + ")(embedded : " + isEmbedded + ")(result : " + isSuccess + ")";
	if(isSuccess) {
		if(isEmbedded) {
			cont.empty();
		} else {
			cont.detach();
		}
		console.info(msg);
	} else {
		cont.detach();
		console.warn(msg);
	}
}
function evalCompileTarget(str) {
	var success = true;
	eval("try {" + str + "} catch (ex) {success = false; console.error(ex);}");
	return success;
}

$("body > * > script[type='vue']").each(function() {
	var cont = $(this).parent();
	compileTarget(cont);
});

var jRootContainers = $("[v-root-container]");
jRootContainers.each(function() {
	$(this).attr("v-root-container", null);
	$(this).find("script[type='vue']").each(function() {
		compileTarget($(this).parent());
	});

	var body = HTMLtoString($(this).clone().appendTo($('<div/>')).parent().html());
	var compiled = ('Vue({template: "' + body + '"})');
	
	var vm = new Vue({
		el: $(this).get(0),
		template:  $(this).clone().appendTo($('<div/>')).parent().html()
	});
	$("#bodyPage").show();
});
$("[v-module]").each(function() {
	$(this).attr("v-module", null);
});
if(jRootContainers.length == 0) {
	$("#bodyPage").show();
}
</script>
		
<%end%>

